# Keyfinder Bot — памятка агента

## Миссия
- Принимать аудио-файлы (audio/voice/document) и отвечать пользователю четырьмя строками: название файла, тон, темп с половиной/удвоением, длительность.
- Предоставлять максимально точные Key/BPM без блокировки Telegram-цикла.

## Архитектура
- `src/audio_processing/analyzer.py` — HPSS → продвинутый анализ хромы (CQT+CENS с оценкой тюнинга) → профили Krumhansl + эвристики по тональности и beat-трекинг по перкуссии (BPM). Возвращает `AnalysisResult` с готовыми данными.
- `src/bot/handlers.py` — Telegram-хэндлеры. Проверяют лимит, скачивают файл во временный каталог, ставят задачи через `asyncio.to_thread` под `asyncio.Semaphore` (ограничение `ANALYSIS_CONCURRENCY`).
- `src/bot/messages.py` — формирует итоговый ответ (строго 4 строки, «Близкий вариант» добавляется пятой при `SHOW_CLOSE_KEY=true`).
- `src/config.py` — читает `.env` (`TELEGRAM_BOT_TOKEN`, `MAX_FILE_MB`, `ANALYSIS_CONCURRENCY`, `KEYFINDER_TEMP`, `SHOW_CLOSE_KEY`).
- `src/utils/files.py` — управляет каталогом `KEYFINDER_TEMP`, генерирует безопасные имена, удаляет временные файлы.

## Чек-лист обработки
1. Получить обновление.
2. Проверить `file_size` против `MAX_FILE_MB` **до** скачивания (если > лимита — ответить ошибкой).
3. Сформировать безопасный путь в `KEYFINDER_TEMP` и скачать файл.
4. Запустить анализ внутри `asyncio.Semaphore` через `asyncio.to_thread`.
5. Анализ: HPSS → гармоника → Key; перкуссия → BPM; вычисление длительности.
6. Отформатировать ответ (4 строки) и отправить пользователю.
7. Удалить временный файл в `finally`.

## Правила качества
- Энгармоника показывается только для нот с `#`/`b`.
- BPM округляется до целого; если не найден — `0` и производные `0`.
- Тональность показываем всегда; при слабом сигнале уверенность стремится к 0%.
- Длительность округляем до ближайшей секунды (`mm:ss`, при необходимости `hh:mm:ss`).
- Файлы, превышающие лимит, не скачиваем и отвечаем понятным сообщением.
- Сообщение всегда состоит из четырёх строк (пятая — только для `Близкий вариант`).
- Строка «Тон» обязательно содержит частоту тоники, A4 и процент уверенности.

## Траблшутинг
- **FFmpeg не найден** — установить по инструкции (winget/choco/apt/brew); убедиться, что бинарь в `PATH`.
- **M4A не открывается** — проверить FFmpeg, при необходимости задать явное расширение через `mime_type`.
- **Мало RAM/CPU** — снизить `ANALYSIS_CONCURRENCY`, сократить длительность анализируемого участка.
- **Слишком длинные треки** — заранее обрезать/отправлять первые 120 секунд.

## План развития
- Очередь задач с приоритетом и отменой.
- Кэширование результатов для повторных отправок одинаковых файлов.
- Оценка доверия (confidence) по Key через Essentia.
- Подготовка systemd-юнита и watchdog для VPS.
