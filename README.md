# Keyfinder Telegram Bot

Телеграм-бот, который принимает аудио-файлы и определяет их тональность (Key), темп (BPM) и длительность. Бот использует `librosa` для аудиоаналитики и `aiogram` v3 для взаимодействия с Telegram. DSP выполняется в фоновых потоках с ограничением параллельных анализов.

## Возможности

- Определение тональности бита с указанием энгармонической альтернативы, частоты тоники и процента уверенности.
- Вычисление темпа (BPM), а также половинного и удвоенного значения.
- Подсчёт длительности трека в формате `mm:ss`.
- Поддержка форматов: MP3, WAV, M4A, OGG, OPUS (audio, voice, document).
- Ограничение на размер файла (по умолчанию 70 МБ) с проверкой до скачивания.
- Очистка временных файлов после обработки.

## Требования

- Python 3.11+
- Установленный FFmpeg (для декодирования аудио через `audioread`).
- Telegram Bot Token.

## Установка FFmpeg

### Windows 11

```powershell
winget install Gyan.FFmpeg
# альтернативы:
# winget install FFmpeg.FFmpeg
# choco install ffmpeg
```

> **Важно:** путь, указанный в переменной `KEYFINDER_TEMP`, не должен содержать пробелов и кириллицы.

### Linux/VPS (Debian/Ubuntu)

```bash
sudo apt-get update && sudo apt-get install -y ffmpeg
```

### macOS (Homebrew)

```bash
brew install ffmpeg
```

## Установка и запуск

### Шаги для Windows 11

```powershell
python -m venv .venv
.\.venv\Scripts\Activate.ps1
pip install -r requirements.txt
python -m src.main
```

### Шаги для Linux/VPS (Debian/Ubuntu)

```bash
python3 -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
python -m src.main
```

(На других платформах команды аналогичные: создайте виртуальное окружение, установите зависимости и запустите `python -m src.main`).

## Настройка окружения

1. Скопируйте пример конфигурации:

   ```bash
   cp .env.example .env
   ```

2. Укажите единственный обязательный параметр — токен бота:

   ```env
   TELEGRAM_BOT_TOKEN=ваш_токен
   ```

   Вставьте токен — и всё: базовые настройки уже зашиты в код. Если хотите детально управлять поведением, раскомментируйте нужные
   строки в `.env` и переопределите их. Ниже приведена справка по доступным опциям и их дефолтным значениям.

   | Переменная | Значение по умолчанию | Назначение |
   | --- | --- | --- |
   | `MAX_FILE_MB` | `70` | Лимит размера входного файла (проверяется до скачивания). |
   | `ANALYSIS_CONCURRENCY` | `2` | Количество одновременных задач анализа, управляемых семафором. |
   | `KEYFINDER_TEMP` | `.temp` | Каталог для временных файлов (создаётся автоматически). |
   | `SHOW_CLOSE_KEY` | `false` | Добавляет пятую строку с ближайшей альтернативной тональностью. |
   | `BPM_MIN` / `BPM_MAX` | `60` / `180` | Предпочтительный диапазон темпов; значения вне диапазона автоматически приводятся к половине/удвоению. |
   | `BPM_DOUBLE_SWITCH` / `BPM_HALF_SWITCH` | `165` / `65` | Дополнительные пороги для выбора половинного или удвоенного темпа по поддержке кандидатов. |
   | `BPM_CANDIDATE_TOLERANCE` | `1.5` | Допустимое расхождение BPM-кандидатов, попадающих в одну «корзину». |
   | `BPM_SUPPORT_RATIO` | `0.9` | Требуемая доля поддержки альтернативного темпа для переключения октавы. |

   Подбор значений универсален: бот уверенно справляется как с рэп/трап битами, так и с большинством поп и электронных треков. При
   необходимости можно расширить диапазон или скорректировать пороги — для опытных пользователей это делается через те же переменные.

## Работа бота

После запуска бот начнёт поллинг обновлений. Пришлите боту аудио-файл (mp3/wav/m4a/ogg/opus) размером до заданного лимита, и он ответит сообщением вида:

```
Тональность бита: track.mp3
Тон: A#min (Bbmin) • 466.16 Гц (A4=440.00 Гц, уверенность 92%)
Темп: 140 BPM (280 / 70)
Длительность: 03:25
```

При включённом `SHOW_CLOSE_KEY` появится дополнительная строка `Близкий вариант: ...`.

Если гармонического материала мало, уверенность будет стремиться к нулю — это сигнал, что результат стоит перепроверить вручную.

## Архитектура

- **HPSS** (`librosa.effects.hpss`) — разделение сигнала на гармоническую и перкуссионную составляющие.
- **Тональность** — гибридный анализ гармонической компоненты: `librosa.feature.chroma_cqt` и `chroma_cens` с оценкой тюнинга, корреляцией с профилями Krumhansl–Schmuckler и дополнительными эвристиками по тонике/терциям.
- **BPM** — оценка на перкуссионной компоненте (`librosa.beat.tempo`).
- **Асинхронность** — тяжёлые вычисления выполняются в `asyncio.to_thread`, параллелизм ограничен `asyncio.Semaphore`.
- **Временные файлы** — сохраняются в каталоге `KEYFINDER_TEMP` и удаляются после завершения обработки.

## Полезные заметки

- Если трек состоит преимущественно из перкуссии или слишком короткий, уверенность по ключу будет низкой (0–10%), а BPM может определиться как `0`.
- Для длинных файлов можно самостоятельно обрезать первые 120 секунд перед отправкой, чтобы сократить время анализа.
- Бот не использует базы данных и хранит файлы только на время анализа.

## Тестирование

В проекте есть синтетические тесты `pytest`, которые не требуют реальных медиа-файлов:

```bash
pytest -q
```

Они проверяют корректность определения тональности, BPM, форматирования энгармоник и итогового сообщения.

## Лицензия

Проект распространяется по лицензии MIT. Используйте и адаптируйте под свои задачи.
