# Keyfinder Telegram Bot

Телеграм-бот, который принимает аудио-файлы и определяет основную тональность (Key), лад, темп (BPM) и длительность трека. Построен на Python 3.11+, использует `aiogram` v3, `librosa` и другие DSP-библиотеки.

## Возможности

- Принимает голосовые сообщения, аудио и документы с музыкальными файлами (mp3, wav, m4a, ogg/opus).
- Ограничение размера файлов — до 70 МБ (файлы крупнее отклоняются до скачивания).
- Асинхронная обработка с выносом тяжёлых вычислений в `asyncio.to_thread`.
- Определение тональности через алгоритм Krumhansl–Schmuckler, вывод с энгармонической альтернативой.
- Расчёт темпа и вывод половинного/удвоенного значения.
- Логирование и аккуратные сообщения об ошибках.

## Требования

- Python 3.11+
- [FFmpeg](https://ffmpeg.org/) — необходим для поддержки большинства аудиоформатов.

### Установка FFmpeg

- **Ubuntu/Debian**:

  ```bash
  sudo apt-get update
  sudo apt-get install ffmpeg
  ```

- **macOS (Homebrew)**:

  ```bash
  brew install ffmpeg
  ```

- **Windows**: скачайте готовый бинарный архив с [https://www.gyan.dev/ffmpeg/builds/](https://www.gyan.dev/ffmpeg/builds/), распакуйте и добавьте путь `bin` в переменную окружения `PATH`.

## Установка и запуск

1. Клонируйте репозиторий и перейдите в директорию проекта `keyfinder_bot`.
2. Создайте и активируйте виртуальное окружение:

   ```bash
   python -m venv .venv
   source .venv/bin/activate  # Windows: .venv\\Scripts\\activate
   ```

3. Установите зависимости:

   ```bash
   pip install -r requirements.txt
   ```

4. Создайте файл `.env` на основе `.env.example` и пропишите токен Телеграм-бота:

   ```bash
   cp .env.example .env
   # Откройте .env и впишите TELEGRAM_BOT_TOKEN
   ```

   Дополнительные переменные окружения (опционально):

   - `SHOW_CLOSE_KEY=True` — отображать «близкий» вариант тональности, если он почти совпадает по корреляции.
   - `MAX_FILE_MB=70` — лимит размера входного файла (МБ).
   - `ANALYSIS_CONCURRENCY=2` — число параллельных DSP-анализов.
   - `KEYFINDER_TEMP=/tmp/keyfinder_bot` — путь к временной директории.

5. Запустите бота:

   ```bash
   python -m src.main
   ```

## Работа с ботом

- Отправьте /start, чтобы получить краткую инструкцию.
- Пришлите аудио-файл (mp3/wav/m4a/ogg/opus) или голосовое сообщение до 70 МБ.
- Бот проанализирует аудио и вернёт сообщение формата:

  ```
  Тональность бита: track.mp3
  Тон: A#min (Bbmin)
  Темп: 140 BPM (280 / 70)
  Длительность: 03:12
  ```

## Ограничения

- Чисто перкуссионные лупы или крайне короткие отрывки могут давать неточные результаты.
- Качество анализа зависит от исходного аудио и сложности аранжировки.

## Структура проекта

```
keyfinder_bot/
  README.md
  requirements.txt
  .env.example
  src/
    main.py
    config.py
    bot/
      __init__.py
      handlers.py
      messages.py
    audio_processing/
      __init__.py
      analyzer.py
      profiles.py
    utils/
      __init__.py
      files.py
```

## Лицензия

Проект распространяется под лицензией MIT (при необходимости обновите под свои требования).
