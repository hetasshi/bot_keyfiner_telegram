# KeyFinder Telegram Bot

Телеграм-бот, который принимает аудио-файлы (audio/voice/document) и определяет основные музыкальные характеристики бита: тональность, тип лада, темп (с половинным и удвоенным значением) и длительность.

## Возможности

- Поддержка форматов: MP3, WAV, OGG/OPUS, M4A (при наличии FFmpeg).
- Автоматическое выделение гармонической и перкуссионной составляющих (HPSS).
- Оценка тональности методом Крумхансл–Шмюклер с выводом энгармонического эквивалента.
- Расчёт темпа и длительности трека.
- Асинхронная обработка с вынесением тяжёлых вычислений в отдельные потоки.
- Ограничение размера входного файла (70 МБ) и очистка временных файлов.

## Требования

- Python 3.11 или новее.
- Установленный FFmpeg (см. ниже).
- Доступ к токену Telegram-бота.

## Установка

```bash
python -m venv .venv
source .venv/bin/activate  # Windows: .venv\\Scripts\\activate
pip install --upgrade pip
pip install -r requirements.txt
```

## Установка FFmpeg

- **Ubuntu / Debian**:
  ```bash
  sudo apt-get update && sudo apt-get install ffmpeg
  ```
- **macOS (Homebrew)**:
  ```bash
  brew install ffmpeg
  ```
- **Windows**:
  1. Скачайте последнюю сборку с https://www.gyan.dev/ffmpeg/builds/.
  2. Распакуйте и добавьте путь к `bin` в переменную окружения `PATH`.

Убедитесь, что команда `ffmpeg -version` успешно выполняется в терминале.

## Настройка окружения

1. Скопируйте файл `.env.example` в `.env`:
   ```bash
   cp .env.example .env
   ```
2. Укажите токен Telegram-бота в переменной `TELEGRAM_BOT_TOKEN`.
3. При необходимости можно включить вывод близкой тональности, установив `SHOW_CLOSE_KEY=true`.

## Запуск

```bash
python -m src.main
```

После запуска бот начнёт polling и будет готов принимать сообщения в Telegram.

## Использование

- Отправьте боту аудио-файл, голосовое сообщение или документ с поддерживаемым аудио-форматом размером до 70 МБ.
- В ответ бот пришлёт сообщение вида:

```
Тональность бита: track.mp3
Тон: A#min (Bbmin)
Темп: 140 BPM (280 / 70)
Длительность: 03:25
```

## Ограничения

- Для очень коротких или сугубо перкуссионных семплов точность определения тональности может быть низкой.
- Ошибки могут возникать при файлах с повреждёнными заголовками или неподдерживаемыми кодеками. В таких случаях бот сообщит о проблеме.

## Структура проекта

```
keyfinder_bot/
  README.md
  requirements.txt
  .env.example
  src/
    main.py
    config.py
    bot/
      __init__.py
      handlers.py
      messages.py
    audio_processing/
      __init__.py
      analyzer.py
      profiles.py
    utils/
      __init__.py
      files.py
```

Готово! После настройки токена и FFmpeg бот можно разворачивать на любом сервере или локально.
