# Keyfinder Telegram Bot

Телеграм-бот, который принимает аудио-файлы и определяет их тональность (Key), темп (BPM) и длительность. Бот использует `librosa` для аудиоаналитики и `aiogram` v3 для взаимодействия с Telegram. DSP выполняется в фоновых потоках с ограничением параллельных анализов.

## Возможности

- Определение тональности бита и отображение энгармонической альтернативы.
- Вычисление темпа (BPM), а также половинного и удвоенного значения.
- Подсчёт длительности трека в формате `mm:ss`.
- Поддержка форматов: MP3, WAV, M4A, OGG, OPUS (audio, voice, document).
- Ограничение на размер файла (по умолчанию 70 МБ) с проверкой до скачивания.
- Очистка временных файлов после обработки.

## Требования

- Python 3.11+
- Установленный FFmpeg (для декодирования аудио через `audioread`).
- Telegram Bot Token.

## Установка FFmpeg

### Windows 11

```powershell
winget install Gyan.FFmpeg
# альтернативы:
# winget install FFmpeg.FFmpeg
# choco install ffmpeg
```

> **Важно:** путь, указанный в переменной `KEYFINDER_TEMP`, не должен содержать пробелов и кириллицы.

### Linux/VPS (Debian/Ubuntu)

```bash
sudo apt-get update && sudo apt-get install -y ffmpeg
```

### macOS (Homebrew)

```bash
brew install ffmpeg
```

## Установка и запуск

### Шаги для Windows 11

```powershell
python -m venv .venv
.\.venv\Scripts\Activate.ps1
pip install -r requirements.txt
python -m src.main
```

### Шаги для Linux/VPS (Debian/Ubuntu)

```bash
python3 -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
python -m src.main
```

(На других платформах команды аналогичные: создайте виртуальное окружение, установите зависимости и запустите `python -m src.main`).

## Настройка окружения

1. Скопируйте пример конфигурации:

   ```bash
   cp .env.example .env
   ```

2. Укажите переменные окружения в файле `.env`:

   ```env
   TELEGRAM_BOT_TOKEN=ваш_токен
   MAX_FILE_MB=70
   ANALYSIS_CONCURRENCY=2
   KEYFINDER_TEMP=.temp
   # SHOW_CLOSE_KEY=true  # опционально выводить "близкий" вариант тональности
   ```

   - `TELEGRAM_BOT_TOKEN` — обязательный токен вашего бота.
   - `MAX_FILE_MB` — лимит размера файла в мегабайтах (используется при проверке до скачивания).
   - `ANALYSIS_CONCURRENCY` — количество одновременных анализов (используется семафором).
   - `KEYFINDER_TEMP` — каталог для временных файлов (создаётся при старте, очищайте при необходимости).
   - `SHOW_CLOSE_KEY` — при `true` добавляет строку с ближайшей альтернативной тональностью.

## Работа бота

После запуска бот начнёт поллинг обновлений. Пришлите боту аудио-файл (mp3/wav/m4a/ogg/opus) размером до заданного лимита, и он ответит сообщением вида:

```
Тональность бита: track.mp3
Тон: A#min (Bbmin)
Темп: 140 BPM (280 / 70)
Длительность: 03:25
```

При включённом `SHOW_CLOSE_KEY` появится дополнительная строка `Близкий вариант: ...`.

## Архитектура

- **HPSS** (`librosa.effects.hpss`) — разделение сигнала на гармоническую и перкуссионную составляющие.
- **Тональность** — анализ гармонической компоненты через Krumhansl–Schmuckler профили и хрома-признаки (`librosa.feature.chroma_stft`).
- **BPM** — оценка на перкуссионной компоненте (`librosa.beat.tempo`).
- **Асинхронность** — тяжёлые вычисления выполняются в `asyncio.to_thread`, параллелизм ограничен `asyncio.Semaphore`.
- **Временные файлы** — сохраняются в каталоге `KEYFINDER_TEMP` и удаляются после завершения обработки.

## Полезные заметки

- Если трек состоит преимущественно из перкуссии или слишком короткий, тональность и BPM могут быть определены как `0` или с низкой точностью.
- Для длинных файлов можно самостоятельно обрезать первые 120 секунд перед отправкой, чтобы сократить время анализа.
- Бот не использует базы данных и хранит файлы только на время анализа.

## Тестирование

В проекте есть синтетические тесты `pytest`, которые не требуют реальных медиа-файлов:

```bash
pytest -q
```

Они проверяют корректность определения тональности, BPM, форматирования энгармоник и итогового сообщения.

## Лицензия

Проект распространяется по лицензии MIT. Используйте и адаптируйте под свои задачи.
